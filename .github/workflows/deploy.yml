name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²å‰ªè´´æ¿ç®¡ç†å™¨

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: ğŸ”§ è®¾ç½®Mavenç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
      run: mvn clean package -DskipTests
    
    - name: ğŸ“Š ä¸Šä¼ æ„å»ºç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifact
        path: target/*.jar
    
    - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PORT: ${{ secrets.SERVER_PORT }}
      run: |
        if [ -n "$DEPLOY_KEY" ] && [ -n "$SERVER_HOST" ]; then
          echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
          # å®‰è£…SSHå®¢æˆ·ç«¯
          sudo apt-get update && sudo apt-get install -y openssh-client
          
          # è®¾ç½®SSHå¯†é’¥
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•å¹¶è®¾ç½®æƒé™
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} \
            'sudo mkdir -p /www/clip && sudo chown -R ${SERVER_USER}:${SERVER_USER} /www/clip && chmod -R 755 /www/clip' || echo "åˆ›å»ºç›®å½•å¤±è´¥"
          
          # åˆ›å»ºåœæ­¢è„šæœ¬ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} \
            'cd /www/clip && if [ ! -f stop-and-deploy.sh ]; then echo "#!/bin/bash" > stop-and-deploy.sh && echo "pkill -f \"java -jar app.jar\" 2>/dev/null || echo \"æ— æ—§è¿›ç¨‹éœ€è¦åœæ­¢\"" >> stop-and-deploy.sh && chmod +x stop-and-deploy.sh; fi' || echo "åˆ›å»ºåœæ­¢è„šæœ¬å¤±è´¥"
          
          # æ£€æŸ¥å¹¶åœæ­¢æ—§æœåŠ¡
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} \
            'cd /www/clip && [ -f stop-and-deploy.sh ] && ./stop-and-deploy.sh || echo "æ— åœæ­¢è„šæœ¬æˆ–è„šæœ¬æ‰§è¡Œå¤±è´¥"' || echo "åœæ­¢æœåŠ¡å¤±è´¥"
          
          # ä¸Šä¼ æ–°çš„jaråŒ…
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -P ${SERVER_PORT:-22} target/*.jar ${SERVER_USER}@${SERVER_HOST}:/www/clip/app.jar || echo "ä¸Šä¼ jaråŒ…å¤±è´¥"
          
          # å¯åŠ¨æ–°æœåŠ¡ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} \
            'set -e && \
            cd /www/clip && \
            echo "=== éƒ¨ç½²æ£€æŸ¥ ===" && \
            if [ -f "clipboard.db" ]; then \
              echo "âœ… æ•°æ®åº“æ–‡ä»¶å­˜åœ¨" && ls -lh clipboard.db; \
            else \
              echo "âš ï¸ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»º"; \
            fi && \
            echo "=== åœæ­¢æ—§æœåŠ¡ ===" && \
            if pgrep -f "java -jar app.jar" > /dev/null; then \
              pkill -f "java -jar app.jar" && echo "âœ… å·²åœæ­¢æ—§æœåŠ¡" && sleep 2; \
            else \
              echo "â„¹ï¸ æ— æ—§è¿›ç¨‹éœ€è¦åœæ­¢"; \
            fi && \
            echo "=== å¯åŠ¨æ–°æœåŠ¡ ===" && \
            nohup java -jar app.jar > app.log 2>&1 & \
            APP_PID=$! && \
            sleep 5 && \
            if ps -p $APP_PID > /dev/null; then \
              echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ (PID: $APP_PID)"; \
              sleep 2 && \
              if curl -s http://localhost:2345/ > /dev/null; then \
                echo "âœ… HTTPæœåŠ¡æ­£å¸¸è¿è¡Œ"; \
              else \
                echo "âš ï¸ HTTPæœåŠ¡å¯èƒ½æœ‰é—®é¢˜ï¼Œæ£€æŸ¥æ—¥å¿—..."; \
                tail -10 app.log; \
              fi; \
            else \
              echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥"; \
              echo "=== é”™è¯¯æ—¥å¿— ==="; \
              tail -10 app.log; \
              exit 1; \
            fi' || echo "å¯åŠ¨æœåŠ¡å¤±è´¥"
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        else
          echo "âš ï¸ æœªé…ç½®æœåŠ¡å™¨ä¿¡æ¯ï¼Œè·³è¿‡è‡ªåŠ¨éƒ¨ç½²"
          echo "ğŸ’¡ å¦‚éœ€å¯ç”¨è‡ªåŠ¨éƒ¨ç½²ï¼Œè¯·åœ¨GitHubä»“åº“çš„Settings > Secretsä¸­æ·»åŠ ä»¥ä¸‹å¯†é’¥ï¼š"
        echo "   - DEPLOY_KEY: SSHç§é’¥"
          echo "   - SERVER_HOST: æœåŠ¡å™¨åœ°å€(åŸŸåæˆ–IP)"
          echo "   - SERVER_USER: æœåŠ¡å™¨ç”¨æˆ·å"
          echo "   - SERVER_PORT: SSHç«¯å£(å¯é€‰ï¼Œé»˜è®¤22)"
        fi
    
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸï¼" >> release-notes.md
        echo "" >> release-notes.md
        echo "**æäº¤ä¿¡æ¯ï¼š** $(git log -1 --pretty=format:'%s')" >> release-notes.md
        echo "**æäº¤è€…ï¼š** $(git log -1 --pretty=format:'%an')" >> release-notes.md
        echo "**æäº¤æ—¶é—´ï¼š** $(git log -1 --pretty=format:'%ci')" >> release-notes.md
        echo "" >> release-notes.md
        echo "### ğŸ“‹ åº”ç”¨ä¿¡æ¯" >> release-notes.md
        echo "- åº”ç”¨åç§°ï¼šå‰ªè´´æ¿ç®¡ç†å™¨" >> release-notes.md
        echo "- è®¿é—®åœ°å€ï¼šhttp://your-domain.com:2345" >> release-notes.md
        echo "- æ„å»ºæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')" >> release-notes.md
    
    - name: ğŸ“¤ ä¸Šä¼ å‘å¸ƒè¯´æ˜
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: release-notes.md