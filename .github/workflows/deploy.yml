name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²å‰ªè´´æ¿ç®¡ç†å™¨

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: ğŸ”§ è®¾ç½®Mavenç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
      run: mvn clean package -DskipTests
    
    - name: ğŸ“Š ä¸Šä¼ æ„å»ºç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifact
        path: target/*.jar
    
    - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PORT: ${{ secrets.SERVER_PORT }}
      run: |
        if [ -n "$DEPLOY_KEY" ] && [ -n "$SERVER_HOST" ]; then
          echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
          # å®‰è£…SSHå®¢æˆ·ç«¯
          sudo apt-get update && sudo apt-get install -y openssh-client
          
          # è®¾ç½®SSHå¯†é’¥
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•å¹¶è®¾ç½®æƒé™
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} \
            'sudo mkdir -p /www/clip && sudo chown -R ${SERVER_USER}:${SERVER_USER} /www/clip && chmod -R 755 /www/clip' || echo "åˆ›å»ºç›®å½•å¤±è´¥"
          
          # ä¸Šä¼ éƒ¨ç½²è„šæœ¬å’ŒjaråŒ…
          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -P ${SERVER_PORT:-22} target/*.jar ${SERVER_USER}@${SERVER_HOST}:/www/clip/app.jar || echo "ä¸Šä¼ jaråŒ…å¤±è´¥"
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -P ${SERVER_PORT:-22} start.sh ${SERVER_USER}@${SERVER_HOST}:/www/clip/start.sh || echo "ä¸Šä¼ start.shå¤±è´¥"
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -P ${SERVER_PORT:-22} stop.sh ${SERVER_USER}@${SERVER_HOST}:/www/clip/stop.sh || echo "ä¸Šä¼ stop.shå¤±è´¥"
          
          # è®¾ç½®è„šæœ¬æƒé™å¹¶æ‰§è¡Œéƒ¨ç½²
          echo "ğŸ”§ æ‰§è¡Œéƒ¨ç½²..."
          DEPLOY_SUCCESS=true
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} \
            'cd /www/clip && \
            chmod +x start.sh stop.sh && \
            echo "=== åœæ­¢æ—§æœåŠ¡ ===" && \
            ./stop.sh || { echo "åœæ­¢æœåŠ¡æ—¶å‡ºé”™ï¼Œç»§ç»­éƒ¨ç½²..."; } && \
            echo "=== æ£€æŸ¥ç«¯å£å ç”¨ ===" && \
            if netstat -tuln 2>/dev/null | grep -q ":2345 "; then \
              echo "ç«¯å£2345è¢«å ç”¨ï¼Œå°è¯•åœæ­¢å ç”¨è¿›ç¨‹..." && \
              pkill -f "java -jar app.jar" 2>/dev/null || true && \
              sleep 3; \
            fi && \
            echo "=== å¯åŠ¨æ–°æœåŠ¡ ===" && \
            ./start.sh' || DEPLOY_SUCCESS=false
          
          if [ "$DEPLOY_SUCCESS" = true ]; then
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
        else
          echo "âš ï¸ æœªé…ç½®æœåŠ¡å™¨ä¿¡æ¯ï¼Œè·³è¿‡è‡ªåŠ¨éƒ¨ç½²"
          echo "ğŸ’¡ å¦‚éœ€å¯ç”¨è‡ªåŠ¨éƒ¨ç½²ï¼Œè¯·åœ¨GitHubä»“åº“çš„Settings > Secretsä¸­æ·»åŠ ä»¥ä¸‹å¯†é’¥ï¼š"
        echo "   - DEPLOY_KEY: SSHç§é’¥"
          echo "   - SERVER_HOST: æœåŠ¡å™¨åœ°å€(åŸŸåæˆ–IP)"
          echo "   - SERVER_USER: æœåŠ¡å™¨ç”¨æˆ·å"
          echo "   - SERVER_PORT: SSHç«¯å£(å¯é€‰ï¼Œé»˜è®¤22)"
        fi
    
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸï¼" >> release-notes.md
        echo "" >> release-notes.md
        echo "**æäº¤ä¿¡æ¯ï¼š** $(git log -1 --pretty=format:'%s')" >> release-notes.md
        echo "**æäº¤è€…ï¼š** $(git log -1 --pretty=format:'%an')" >> release-notes.md
        echo "**æäº¤æ—¶é—´ï¼š** $(git log -1 --pretty=format:'%ci')" >> release-notes.md
        echo "" >> release-notes.md
        echo "### ğŸ“‹ åº”ç”¨ä¿¡æ¯" >> release-notes.md
        echo "- åº”ç”¨åç§°ï¼šå‰ªè´´æ¿ç®¡ç†å™¨" >> release-notes.md
        echo "- è®¿é—®åœ°å€ï¼šhttp://your-domain.com:2345" >> release-notes.md
        echo "- æ„å»ºæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')" >> release-notes.md
    
    - name: ğŸ“¤ ä¸Šä¼ å‘å¸ƒè¯´æ˜
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: release-notes.md